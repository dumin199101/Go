#  微服务

## ProtoBuf

Protobuf是一种结构化数据的存储格式，平台无关，语言无关，可扩展。

### 安装

- 安装protobuf

> windows平台安装

去网站下载一个protoc.exe,网址：https://github.com/protocolbuffers/protobuf/releases，
同样放在GOPATH/bin下

> linux平台安装

>> 下载 protobuf安装包

```
git clone https://github.com/protocolbuffers/protobuf.git
```

>> 安装依赖库

```
sudo yum install autoconf automake libtool curl make g++ unzip libffi-dev -y
```

>> 安装

```
  $ cd protobuf/
  $ ./autogen.sh
  $ ./configure
  $ make
  $ sudo make install
  $ sudo ldconfig                  // 刷新共享库，很重要的一步
```

- 获取proto包（Go语言的proto API接口）
```
go get github.com/golang/protobuf/proto
```

- 获取protoc-gen-go
```
go get github.com/golang/protobuf/protoc-gen-go
```
在GOPATH/bin下生成protoc-gen-go.exe

### protobuf格式

```
syntax = "proto3";
option go_package = "./;prototest";
message Person {
   string name = 1;
   int32 age = 2;
   repeated int32 height = 3;
   string motto = 4;  //格言
}
```

#### 生成对应客户端代码
```
protoc --go_out ./ person.proto
```
Code generated by protoc-gen-go，文件后缀为.pb.go


#### 编译protobuf常见bug

- package xxx is not in GOROOT or GOPATH

原因：1.开启了Go mod，没有对应模块 2.没开启Go mod,但是GOPATH中没有对应模块

- Missing ‘go_package‘ option in “person.proto“

原因：是因为在 proto3 的语法中缺少了 option go_package

```
option go_package = "aaa;bbb";
```

aaa 表示生成的go文件的存放地址，会自动生成目录的,建议使用当前目录：./。

bbb 表示生成的go文件所属的包名

## Go Module

开启Go mod,并设置代理
```
 go env -w GO111MODULE=on
 go env -w GOPROXY=https://goproxy.cn,direct
```

常用命令

```
go mod init [模块名]  //在当前目录下初始化新的模块，此命令会在当前目录中初始化和创建一个新的go.mod文件
go mod tidy        //添加缺失的模块以及移除无用的模块，此动作会执行下载动作，类似于npm install.执行后会生成go.sum文件
go mod download  //使用此命令来下载指定的模块，模块的格式可以根据主模块依赖的形式或者path@version形式指定。如果没有指定参数，此命令会将主模块下的所有依赖下载下来,类似于npm install.一般使用go get替代
go mod vendor   //此命令会将build阶段需要的所有依赖包放到主模块所在的vendor目录中
```


## RPC

### go实现rpc

- golang官方的net/rpc库使用encoding/gob进行编解码，支持tcp和http数据传输方式，由于其他语言不支持gob编解码方式，所以golang的RPC只支持golang开发的服务器与客户端之间的交互.[gob流]

- 官方还提供了net/rpc/jsonrpc库实现RPC方法，jsonrpc采用encoding/json进行数据编解码，因而支持跨语言调用，目前jsonrpc库是基于tcp协议实现的，暂不支持http传输方式。[json字符串]

###gRPC

gRPC是一个高性能、开源、通用的RPC框架，底层是通讯协议，采用Protobuf数据序列化协议[protobuf]。

